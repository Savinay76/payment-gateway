<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <meta charset="UTF-8" />
</head>
<body>

<div data-test-id="checkout-container">
  <h2>Complete Payment</h2>

  <div>
    Order ID:
    <span id="orderId" data-test-id="order-id"></span>
  </div>

  <button onclick="payUPI()" data-test-id="method-upi">
    Pay via UPI
  </button>

  <div id="processing" data-test-id="processing-state" style="display:none;">
    Processing payment...
  </div>

  <div id="success" data-test-id="success-state" style="display:none;">
    <h3>Payment Successful!</h3>
    Payment ID: <span id="paymentId"></span>
  </div>

  <div id="error" data-test-id="error-state" style="display:none;">
    <h3>Payment Failed</h3>
  </div>
</div>

<script>
console.log("Checkout JS loaded");

/* Read order_id */
const orderId = new URLSearchParams(window.location.search).get("order_id");
document.getElementById("orderId").innerText = orderId;

/* Create payment */
async function payUPI() {
  alert("Pay UPI clicked");

  document.getElementById("processing").style.display = "block";

  const res = await fetch("http://localhost:8000/api/v1/payments", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Api-Key": "key_test_abc123",
      "X-Api-Secret": "secret_test_xyz789"
    },
    body: JSON.stringify({
      order_id: orderId,
      method: "upi",
      vpa: "user@paytm"
    })
  });

  const data = await res.json();
  console.log("Payment response:", data);

  if (!data.id) {
    document.getElementById("processing").style.display = "none";
    document.getElementById("error").style.display = "block";
    return;
  }

  pollPaymentStatus(data.id);
}

/* Poll payment status */
function pollPaymentStatus(paymentId) {
  const interval = setInterval(async () => {
    const res = await fetch(
      `http://localhost:8000/api/v1/payments/${paymentId}`,
      {
        headers: {
          "X-Api-Key": "key_test_abc123",
          "X-Api-Secret": "secret_test_xyz789"
        }
      }
    );

    const data = await res.json();
    console.log("Polling:", data.status);

    if (data.status === "success") {
      clearInterval(interval);
      document.getElementById("processing").style.display = "none";
      document.getElementById("paymentId").innerText = paymentId;
      document.getElementById("success").style.display = "block";
    }

    if (data.status === "failed") {
      clearInterval(interval);
      document.getElementById("processing").style.display = "none";
      document.getElementById("error").style.display = "block";
    }
  }, 2000);
}
</script>

</body>
</html>
